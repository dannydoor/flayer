<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0" />
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/Controller.css">
    <link rel="stylesheet" href="./css/queue.css">
    <link rel="stylesheet" href="./css/musicItems.css">
    <link rel="stylesheet" href="./js/simpleBar/simplebar.css">
    <script type="text/javascript" src="./js/jwplayer.js"></script>
    <script>
      jwplayer.key = 'Bch7bd0cZt0adCRYHGveauTP1LaJlq1EMyrU/IxgfrGDc3gTqZxyPFEKKMI';
    </script>
    <script type="text/javascript" src="./js/artworks.js"></script>
    <script type="text/javascript" src="./js/md5.js"></script>
    <script type="text/javascript" src="./js/slip.js"></script>
    <script type="text/javascript" src="./js/musicItems.js"></script>
    <script type="text/javascript" src="./js/controller.js"></script>
    <script type="text/javascript" src="./js/queueManager.js"></script>
    <script type="text/javascript" src="./js/test2.js"></script>
    <script type="text/javascript" src="./js/testDB.js"></script>
    <title>flayer</title>
  </head>
  <body>
    <div class="container">
      <div id='tab' class="invisible">
        <!-- <div id="test-div"></div> -->
        <div id="queue-container" class="tab-container">
          <div class="header">
            <span class="header-title">재생 중인 목록</span>
            <button class="close-button"></button>
          </div>
          <div class="content">
            <div class="scrollable" data-simplebar>
              <div class="queue-item-header record">
                <span class="queue-desc">기록</span>
                <span id="clear-record" class="queue-desc-sub">비우기</span>
              </div>
              <div id="record-stack"></div>
              <div class="queue-item-header queue">
                <div class="queue-desc-container">
                  <span class="queue-desc">재생 대기열</span>
                  <span class="queue-desc-sub" id="curr-playlist-name"></span>
                </div>
                <div id="queue-status" class="active">
                  <div class="tooltip on">
                    <div class="tooltip-header">
                      연결됨
                    </div>
                    <div class="tooltip-desc">
                      <p>
                        재생 중인 플레이리스트의<br>변경된 곡 순서가 자동으로<br>반영됩니다
                      </p>
                    </div>
                  </div>
                  <div class="tooltip off">
                    <div class="tooltip-header">
                      연결해제됨
                    </div>
                    <div class="tooltip-desc">
                      <p>
                        재생 중인 플레이리스트의<br>변경된 곡 순서가 자동으로<br>반영되지 않습니다
                      </p>
                    </div>
                  </div>
                </div>
              </div>
              <div id="queue-content">
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="video"></div>
      <div class="control-panel">
        <button id="open-queue" data-tooltip="재생 중인 목록 보기">
          <div class="tooltip">
            <div class="tooltip-desc">
              <strong>재생 중인 목록</strong>
            </div>
          </div>
        </button>
        <div class="control-container">
          <button id="repeat-button"></button>
          <div class="control-buttons">
            <button id="prev-button">
              <div class="tooltip">
                <div class="tooltip-header">
                  이전 곡
                </div>
                <div class="tooltip-desc">
                  <strong></strong>
                  <span></span>
                </div>
              </div>
            </button>
            <button id="play-or-pause" class="play"></button>
            <button id="next-button">
              <div class="tooltip">
                <div class="tooltip-header">
                  다음 곡
                </div>
                <div class="tooltip-desc">
                  <strong></strong>
                  <span></span>
                </div>
              </div>
            </button>
          </div>
          <button id="shuffle-button"></button>
        </div>
      </div>
      <div class="play-volume-bars">
        <input type="range" id="play-bar" value="0">
        <div class="timers">
          <span id="current-time">00:00</span>
          <span id="remaining-time">- 05:02</span>
        </div>
        <div class="volume-bar-container">
          <div id="mute-button"></div>
          <input type="range" id="volume-bar" value="0">
          <div id="volume-button"></div>
        </div>
      </div>
      <div class="song-info-section">
        <div class="song-info-block">
          <div class="curr-song-info">
            <strong id="curr-song-title">DM</strong>
            <span id="curr-song-artist">fromis_9</span>
          </div>
          <button id="open-curr-playlist">
            <div class="tooltip">
              <div class="tooltip-header">
                재생 중인 플레이리스트
              </div>
              <div class="tooltip-desc">
                <strong></strong>
              </div>
            </div>
          </button>
          <button id="like-this-button"></button>
          <button id="meatballs-button"></button>
        </div>
        <button id="fullscreen-button" data-tooltip="전체화면">
          <div class="tooltip">
            <div class="tooltip-desc">
              <strong>전체 화면</strong>
            </div>
          </div>
        </button>
      </div>
      <div id="element-storehouse"></div>
      <div id="modal-storehouse"></div>
      <div id="contextmenu-storehouse"></div>
    </div>
    <script src="./js/simpleBar/simplebar.js"></script>
    <script>
      function main() {
        let initTime = Date.now();
        let objectFactory = new ObjectFactory();
        let map = new Map();
        objTable = objectFactory.objHashTableBuilder(db);
        // console.log("객체 생성까지: "+ (Date.now() - initTime));

        let [sorted1, sorted2, sorted3, sorted4] = objectFactory.getSortedArr(objTable);
        // console.log("배열 정렬까지: "+ (Date.now() - initTime));
        
        let recordFragment = new DocumentFragment();
        let queueFragment = new DocumentFragment();
        let context = "library";

        for (let item of sorted1) {
          let recordElem = document.createElement("div", { is: "record-item"});
          recordElem.setup(item);
          map.set(item.id, 1);
          recordFragment.append(recordElem);
        }
        // console.log("sorted1 요소 생성까지: "+ (Date.now() - initTime));
        for (let item of sorted3) {
          let queueElem = document.createElement("div", { is: "queue-item"});
          queueElem.setup(item, context);
          queueFragment.append(queueElem);
        }
        // console.log("sorted2 요소 생성까지: "+ (Date.now() - initTime));

        queueFragment.firstElementChild.classList.add("current");

        return [recordFragment, queueFragment, map];
        /* window["record-stack"].append(recordFragment);
        window["queue-content"].append(queueFragment);
        console.log("DOM 렌더링까지: "+ (Date.now() - initTime));

        let scrollHeight = getComputedStyle(window["record-stack"]).height;
        console.log(scrollHeight);
        console.log("스크롤 크기 계산까지: "+ (Date.now() - initTime)); */ 

        ;
        
        
      }

      let [recordStack, queueContent, map] = main();
/*
      async function getFileFromImgUrl(url) {
        const response = await fetch(url);
        const data = await response.blob();
        return new File([data], url, {
          type: "image/png",
        });
      }
      var imgData96, imgData128, imgData192, imgData256, imgData384, imgData512;
      let imgDataArr = [96, 128, 192, 256, 384, 512];
      function dataUrlConverter() {
        document.querySelectorAll('img').forEach(async (item, index) => {
          let file = await getFileFromImgUrl(item.src);
          console.log(file.result);
          let reader = new FileReader();
        
          reader.onload = (e) => {
            console.log(reader.result);
            window["imgData" + imgDataArr[index]] = reader.result;
          };

          reader.onerror = (e) => {
            throw reader.error;
          };

          reader.readAsDataURL(file);
        });
      }
      dataUrlConverter();
      window["temp-imgs"].remove();
*/
      var objTable;
      var inputEvent = new InputEvent("input");
      var queueManager = new QueueManager(true, recordStack, queueContent, queueContent, map);
      var modalManager = new ModalManager();
      var playlistManager = new PlaylistManager();
      var libraryManager = new LibraryManager();
      var controller = new Controller();
      // new SimpleBar(document.querySelector('.scrollable'))
    </script>
  </body>
</html>